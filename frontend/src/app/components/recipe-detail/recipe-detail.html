<div class="container py-5">
      <!-- Loading State -->
      @if (isLoading()) {
        <div class="d-flex justify-content-center py-5">
           <div class="spinner-border text-primary" role="status">
             <span class="visually-hidden">Caricamento...</span>
           </div>
        </div>
      }

      <!-- Error State -->
      @if (error()) {
        <div class="alert alert-danger shadow-sm border-0 d-flex align-items-center">
          <i class="fa-solid fa-circle-exclamation fs-4 me-3"></i>
          <div>
            <strong>Errore nel caricamento della ricetta.</strong>
            <p class="mb-0 small">{{ error() }}</p>
          </div>
        </div>
      }

      <!-- Content -->
      @if (recipe(); as r) {
        <div class="row g-4">
          <!-- Modern Elegant Header -->
          <div class="col-12">
            <div class="position-relative rounded-4 overflow-hidden mb-4 shadow-lg" 
                 [style.background-image]="r.imageUrl ? 'url(' + r.imageUrl + ')' : 'linear-gradient(135deg, #1A1C20 0%, #2D3436 100%)'"
                 [style.background-size]="'cover'"
                 [style.background-position]="'center'"
                 style="min-height: 320px; background-color: #1A1C20;">
                 
                 <!-- Dark Overlay for Readability if Image exists -->
                 @if (r.imageUrl) {
                    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75"></div>
                 }

                 <!-- Decorative pattern overlay -->
                 <div class="position-absolute top-0 start-0 w-100 h-100" 
                      style="opacity: 0.05; background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 20px 20px;">
                 </div>

                 <div class="position-relative h-100 d-flex flex-column justify-content-between p-4 p-lg-5">
                    
                    <!-- Top Bar - Mobile Optimized -->
                    <div class="d-flex flex-column gap-2 gap-md-3 align-items-end">
                         <div class="d-flex justify-content-between align-items-start w-100 flex-wrap gap-2">
                             <div class="d-flex gap-2">
                                 <a routerLink="/" class="btn btn-sm btn-outline-light rounded-pill px-2 px-md-3" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border-color: rgba(255,255,255,0.2);">
                                    <i class="fa-solid fa-arrow-left me-0 me-md-2"></i><span class="d-none d-md-inline">Torna al Ricettario</span>
                                 </a>
                             </div>
                             <div class="d-flex gap-2 flex-wrap">
                                 <button (click)="downloadPdf()" class="btn btn-sm rounded-pill px-2 px-md-3" style="background: rgba(220,53,69,0.9); backdrop-filter: blur(5px); border-color: rgba(220,53,69,1); color: white;" title="Scarica PDF">
                                    <i class="fa-solid fa-file-pdf me-0 me-md-1"></i><span class="d-none d-sm-inline"> PDF</span>
                                 </button>
                                 <a [routerLink]="['/editor', r.id]" class="btn btn-sm btn-outline-light rounded-pill px-2 px-md-3" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border-color: rgba(255,255,255,0.2);">
                                    <i class="fa-solid fa-pencil me-0 me-md-2"></i><span class="d-none d-sm-inline">Modifica</span>
                                 </a>
                                 @if (getDifficultyInfo(r.difficulty); as diff) {
                                    <span class="badge rounded-pill px-2 px-md-3 py-2 fw-normal tracking-wide d-flex align-items-center" 
                                          style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);">
                                        <i class="{{diff.icon}} me-0 me-md-2 {{diff.class}}"></i><span class="d-none d-sm-inline">{{ diff.label }}</span>
                                    </span>
                                 }
                             </div>
                         </div>
                         
                         <!-- Delete Button - Separate Row for Emphasis -->
                         <button (click)="deleteRecipe()" 
                                 [disabled]="isDeleting()"
                                 class="btn btn-sm rounded-pill px-3 px-md-4 py-2" 
                                 style="background: rgba(220,53,69,0.25); backdrop-filter: blur(5px); border: 2px solid rgba(220,53,69,0.7); color: #ff8a8a; font-weight: 500;">
                            @if (isDeleting()) {
                               <i class="fa-solid fa-spinner fa-spin me-2"></i><span class="d-none d-sm-inline">Eliminazione...</span>
                            } @else {
                               <i class="fa-solid fa-trash me-0 me-sm-2"></i><span class="d-none d-sm-inline">Elimina Ricetta</span>
                            }
                         </button>
                    </div>

                    <!-- Title & Desc -->
                    <div class="mt-3 mt-md-4">
                        <h1 class="display-5 display-md-3 fw-bold text-white mb-2" style="letter-spacing: -1px; font-family: var(--kh-font-display); font-size: clamp(1.5rem, 5vw, 3rem);">{{ r.title }}</h1>
                        <p class="lead text-white-50 mb-2 mb-md-3 fw-light" style="max-width: 650px; font-size: clamp(0.875rem, 2vw, 1.125rem);">{{ r.description }}</p>
                        
                        <!-- Category & Tags -->
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-4">
                            @if (r.category) {
                                <span class="badge rounded-pill px-3 py-2" 
                                      [style.background-color]="(r.category.color || '#6c757d') + '40'"
                                      [style.color]="'white'"
                                      [style.border]="'1px solid ' + (r.category.color || '#6c757d')">
                                    <i [class]="(r.category.icon || 'fa-solid fa-folder') + ' me-1'"></i>
                                    {{ r.category.name }}
                                </span>
                            }
                            @if (r.tags && r.tags.length > 0) {
                                @for (tag of r.tags; track tag.id) {
                                    <span class="badge rounded-pill px-3 py-2" 
                                          style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);">
                                        <i class="fa-solid fa-tag me-1"></i>{{ tag.name }}
                                    </span>
                                }
                            }
                        </div>

                        <!-- Stats Grid - Responsive -->
                        <div class="d-flex flex-column flex-sm-row flex-wrap gap-3 gap-md-4 border-top border-white border-opacity-10 pt-3 pt-md-4">
                             <!-- Total Time -->
                             <div class="d-flex align-items-center">
                                 <div class="rounded-circle d-flex align-items-center justify-content-center me-2 me-md-3" 
                                      style="width: 36px; height: 36px; background: rgba(255,255,255,0.08);">
                                    <i class="fa-regular fa-clock text-info" style="font-size: 1rem;"></i>
                                 </div>
                                 <div class="d-flex flex-column">
                                    <span class="text-uppercase text-white-50" style="font-size: 0.6rem; letter-spacing: 1px;">Tempo Totale</span>
                                    <span class="text-white fw-medium" style="font-size: clamp(1rem, 3vw, 1.25rem);">{{ totalTime() | timeFormat }}</span>
                                 </div>
                             </div>
                             
                             <!-- Prep Time -->
                             <div class="d-flex align-items-center">
                                 <div class="rounded-circle d-flex align-items-center justify-content-center me-2 me-md-3" 
                                      style="width: 36px; height: 36px; background: rgba(255,255,255,0.08);">
                                    <i class="fa-solid fa-hourglass-half text-warning" style="font-size: 1rem;"></i>
                                 </div>
                                 <div class="d-flex flex-column">
                                    <span class="text-uppercase text-white-50" style="font-size: 0.6rem; letter-spacing: 1px;">Prep (Attivo)</span>
                                    <span class="text-white fw-medium" style="font-size: clamp(1rem, 3vw, 1.25rem);">{{ activePrepTime() | timeFormat }}</span>
                                 </div>
                             </div>

                             <!-- Pieces (Calculated) -->
                             <div class="d-flex align-items-center">
                                <div class="rounded-circle d-flex align-items-center justify-content-center me-2 me-md-3" 
                                     style="width: 36px; height: 36px; background: rgba(255,255,255,0.08);">
                                   <i class="fa-solid fa-box text-success" style="font-size: 1rem;"></i>
                                </div>
                                <div class="d-flex flex-column">
                                   <span class="text-uppercase text-white-50" style="font-size: 0.6rem; letter-spacing: 1px;">Resa</span>
                                   <span class="text-white fw-medium" style="font-size: clamp(1rem, 3vw, 1.25rem);">{{ desiredPieces() }}<span class="text-white-50 ms-1" style="font-size: 0.875rem;">pz</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
          </div>

          <!-- Left Column: Ingredients & Calculator -->
          <div class="col-lg-4">
             <!-- Calculator -->
             <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom-0 py-4 px-4">
                   <h5 class="fw-bold mb-0 text-dark" style="letter-spacing: -0.5px;"><i class="fa-solid fa-calculator me-2" style="color: var(--kh-primary);"></i>Dimensione Richiesta</h5>
                </div>
                <div class="card-body px-4 pb-4 pt-0">
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label small text-muted fw-medium mb-2">Pezzi</label>
                            <input type="number" class="form-control bg-light border-0 text-dark fw-bold text-center rounded-3" [ngModel]="desiredPieces()" (ngModelChange)="desiredPieces.set($event)">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted fw-medium mb-2">Peso (g)</label>
                            <input type="number" class="form-control bg-light border-0 text-dark fw-bold text-center rounded-3" [ngModel]="desiredPieceWeight()" (ngModelChange)="desiredPieceWeight.set($event)">
                        </div>
                        <div class="col-12 pt-2">
                           <div class="d-flex justify-content-between align-items-center p-3 rounded-3 bg-danger text-white">
                               <span class="small fw-medium">Totale Impasto</span>
                               <span class="fw-bold fs-5">{{ (desiredPieces() * desiredPieceWeight()) | number:'1.0-0' }}g</span>
                           </div>
                        </div>
                    </div>
                </div>
             </div>
             
             <!-- Ingredients List -->
             <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom-0 py-4 px-4 sticky-top z-1">
                   <h5 class="fw-bold mb-0 text-dark" style="letter-spacing: -0.5px;"><i class="fa-solid fa-basket-shopping me-2" style="color: var(--kh-primary);"></i>Lista della Spesa</h5>
                </div>
                <div class="card-body p-0 d-flex flex-column" style="max-height: 500px;">
                   <div class="overflow-y-auto custom-scrollbar flex-grow-1">
                       <ul class="list-group list-group-flush">
                          @for (ing of scaledIngredients(); track ing.name) {
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3 px-4 border-0 hover-bg-light transition-base">
                               <div class="d-flex align-items-center">
                                   <i class="fa-regular fa-circle-check text-secondary text-opacity-25 me-3"></i>
                                   <span class="fw-medium text-dark">{{ ing.name }}</span>
                               </div>
                               <div class="text-end lh-1">
                                  <div class="fw-bold text-dark fs-5 mb-1">{{ ing.quantity | number:'1.0-1' }}<span class="fs-6 text-muted fw-normal ms-1">{{ ing.unit }}</span></div>
                                  @if(ing.bakersPercentage) {
                                      <small class="badge bg-light text-secondary border font-monospace">{{ ing.bakersPercentage | number:'1.0-1' }}%</small>
                                  }
                               </div>
                            </li>
                          }
                       </ul>
                   </div>
                   <div class="p-4 mt-auto border-top">
                        <button (click)="downloadPdf()" class="btn btn-danger w-100 py-2 rounded-3 d-flex align-items-center justify-content-center gap-2">
                            <i class="fa-solid fa-file-pdf fs-5"></i>
                            <span>Scarica PDF</span>
                        </button>
                   </div>
                </div>
             </div>

             <!-- Video Section (Restored) -->
              @if (r.videos && r.videos.length > 0) {
                  <div class="card border-0 shadow-sm mb-4">
                      <div class="card-header bg-white py-3 border-bottom-0">
                          <h5 class="fw-bold mb-0 text-dark"><i class="fa-solid fa-play-circle me-2" style="color: var(--kh-primary);"></i>Media & Video</h5>
                      </div>
                      <div class="card-body p-4 pt-0">
                          <div class="d-flex flex-column gap-3">
                              @for (vid of r.videos; track vid.url) {
                                  <div>
                                      @if (getSafeVideoUrl(vid.url); as safeUrl) {
                                          <div class="ratio ratio-16x9 rounded overflow-hidden shadow-sm bg-dark">
                                               <iframe [src]="safeUrl" title="Video" allowfullscreen></iframe>
                                          </div>
                                      } @else {
                                          <a [href]="vid.url" target="_blank" class="d-block p-4 bg-light rounded text-decoration-none text-center border hover-shadow w-100 d-flex flex-column justify-content-center align-items-center">
                                              <i class="fa-solid fa-link fs-1 text-secondary mb-2"></i>
                                              <div class="text-dark fw-bold text-truncate w-100 mb-1">{{ vid.url }}</div>
                                              <small class="text-muted">Apri Link Esterno <i class="fa-solid fa-arrow-up-right-from-square ms-1"></i></small>
                                          </a>
                                      }
                                  </div>
                              }
                          </div>
                      </div>
                  </div>
              }
          </div>

          <!-- Right Column: Phases Timeline -->
          <div class="col-lg-8">
             <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom-0 py-3 py-lg-4 px-3 px-lg-5 d-flex justify-content-between align-items-center">
                   <h5 class="fw-bold mb-0 text-dark fs-5 fs-lg-4" style="letter-spacing: -0.5px;">Procedimento</h5>
                   <span class="badge bg-light text-muted border">{{ scaledPhases().length }} fasi</span>
                </div>
                <div class="card-body p-3 p-lg-5 pt-0">
                    <!-- Desktop Timeline -->
                    <div class="timeline position-relative d-none d-md-block">
                        <!-- Vertical line (Center at 22px) -->
                        <div class="position-absolute h-100 bg-secondary bg-opacity-10 rounded" style="width: 4px; left: 20px; top: 10px;"></div>

                        @for (phase of scaledPhases(); track $index; let last = $last) {
                            <div class="timeline-item position-relative pb-5 ps-5">
                                <!-- Marker (Center at 22px since width is 44px and left is 0) -->
                                <div class="position-absolute top-0 start-0 rounded-circle border border-4 border-white shadow-sm d-flex align-items-center justify-content-center" 
                                     [style.background-color]="getPhaseColor(phase)"
                                     style="width: 44px; height: 44px; z-index: 2; left: 0;">
                                   <i class="fs-5 text-white" [ngClass]="getPhaseIcon(phase)"></i>
                                </div>
                                
                                <!-- Content -->
                                <div class="card border-0 bg-light bg-opacity-50 rounded-4 overflow-hidden transition-hover ms-2">
                                    <div class="card-body p-4">
                                        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                            <h5 class="fw-bold mb-0" [style.color]="getPhaseColor(phase)">{{ phase.title }}</h5>
                                            <div class="d-flex gap-2">
                                                @if (phase.temperature) {
                                                    <span class="badge bg-white text-danger border shadow-sm rounded-pill px-3 py-2 fw-normal">
                                                        <i class="fa-solid fa-temperature-half me-1"></i>{{ phase.temperature }}°C
                                                    </span>
                                                }
                                                <span class="badge bg-white text-dark border shadow-sm rounded-pill px-3 py-2 fw-normal font-monospace">
                                                    <i class="fa-solid fa-stopwatch me-1 text-secondary"></i>{{ phase.durationMinutes | timeFormat }}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        @if (phase.description) {
                                            <p class="card-text text-secondary mb-3 lh-lg">{{ phase.description }}</p>
                                        }

                                        <!-- Phase Ingredients -->
                                        @if (phase.phaseIngredients && phase.phaseIngredients.length > 0) {
                                           <div class="bg-white rounded-3 p-3 border border-light">
                                              <small class="d-block fw-bold text-uppercase text-muted mb-2" style="font-size: 0.7rem; letter-spacing: 0.5px;">Ingredienti Fase</small>
                                              <div class="d-flex flex-wrap gap-2">
                                                 @for (pi of phase.phaseIngredients; track pi.ingredientName) {
                                                    <div class="d-flex align-items-center bg-light rounded-pill px-3 py-1 border">
                                                       <span class="text-secondary small me-2">
                                                           @if (isPhaseRef(pi.ingredientName)) {
                                                               <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-10 me-1">DA</span>
                                                           }
                                                           {{ resolveIngredientName(pi.ingredientName) }}
                                                       </span>
                                                       @if (!isPhaseRef(pi.ingredientName) || pi.quantity > 0) {
                                                          <span class="fw-bold text-dark small">{{ pi.quantity | number:'1.0-1' }}g</span>
                                                       }
                                                    </div>
                                                 }
                                              </div>
                                           </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Mobile Cards View -->
                    <div class="d-md-none">
                        @for (phase of scaledPhases(); track $index; let i = $index) {
                            <div class="mobile-phase-card mb-3">
                                <!-- Phase Header with Color Accent -->
                                <div class="phase-card-header d-flex align-items-center gap-2 mb-2">
                                    <div class="phase-number rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                                         [style.background-color]="getPhaseColor(phase)"
                                         style="width: 32px; height: 32px;">
                                        <span class="text-white fw-bold" style="font-size: 0.8rem;">{{ i + 1 }}</span>
                                    </div>
                                    <h6 class="fw-bold mb-0 flex-grow-1" [style.color]="getPhaseColor(phase)" style="font-size: 0.95rem;">{{ phase.title }}</h6>
                                </div>
                                
                                <!-- Phase Meta Badges -->
                                <div class="phase-meta d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-light text-dark border rounded-pill px-2 py-1" style="font-size: 0.7rem;">
                                        <i class="fa-solid fa-stopwatch me-1 text-secondary"></i>{{ phase.durationMinutes | timeFormat }}
                                    </span>
                                    @if (phase.temperature) {
                                        <span class="badge bg-light text-danger border rounded-pill px-2 py-1" style="font-size: 0.7rem;">
                                            <i class="fa-solid fa-temperature-half me-1"></i>{{ phase.temperature }}°C
                                        </span>
                                    }
                                </div>
                                
                                <!-- Description -->
                                @if (phase.description) {
                                    <p class="phase-description text-secondary mb-2" style="font-size: 0.85rem; line-height: 1.5;">{{ phase.description }}</p>
                                }
                                
                                <!-- Phase Ingredients -->
                                @if (phase.phaseIngredients && phase.phaseIngredients.length > 0) {
                                    <div class="phase-ingredients bg-light rounded-3 p-2">
                                        <small class="d-block fw-bold text-uppercase text-muted mb-2" style="font-size: 0.6rem; letter-spacing: 0.5px;">Ingredienti</small>
                                        <div class="d-flex flex-wrap gap-1">
                                            @for (pi of phase.phaseIngredients; track pi.ingredientName) {
                                                <span class="badge bg-white border text-dark rounded-pill px-2 py-1" style="font-size: 0.7rem;">
                                                    @if (isPhaseRef(pi.ingredientName)) {
                                                        <span class="text-muted">↩</span>
                                                    }
                                                    {{ resolveIngredientName(pi.ingredientName) }}
                                                    @if (!isPhaseRef(pi.ingredientName) || pi.quantity > 0) {
                                                        <strong class="ms-1">{{ pi.quantity | number:'1.0-1' }}g</strong>
                                                    }
                                                </span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
             </div>
          </div>
        </div>
      }
    </div>